<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة مشتركي الإنترنت</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            font-size: 14px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .form-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 12px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
        }
        button:hover {
            background-color: #3367d6;
        }
        button.delete {
            background-color: #f44336;
        }
        button.edit {
            background-color: #ff9800;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 12px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #4285f4;
            color: white;
        }
        .paid {
            background-color: #e8f5e9;
        }
        .unpaid {
            background-color: #ffebee;
        }
        .subscription-badge {
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 0.7em;
            display: inline-block;
        }
        .max { background-color: #d1c4e9; color: #4527a0; }
        .plus { background-color: #bbdefb; color: #1565c0; }
        .standard { background-color: #c8e6c9; color: #2e7d32; }
        .nb1 { background-color: #ffccbc; color: #e64a19; }
        .other { background-color: #e0e0e0; color: #424242; }
        #customAmountContainer {
            display: none;
            margin-top: 10px;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .action-buttons button {
            padding: 5px 8px;
            font-size: 12px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary-card h4 {
            margin-top: 0;
            color: #4285f4;
        }
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                flex-wrap: wrap;
            }
            .form-container {
                flex: 1;
                min-width: 300px;
            }
            table {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>

<h1 style="color: #4285f4; text-align: center;">إدارة مشتركي الإنترنت</h1>

<div class="container">
    <!-- قسم إضافة مشترك جديد -->
    <div class="form-container">
        <h2>إضافة/تعديل مشترك</h2>
        <input type="hidden" id="editId" value="">
        <div class="form-group">
            <label>اسم المشترك:</label>
            <input type="text" id="customerName">
        </div>
        <div class="form-group">
            <label>نوع الاشتراك:</label>
            <select id="subscriptionType" onchange="checkSubscriptionType()">
                <option value="nb1">NB1 - 25,000 دينار</option>
                <option value="max">ماكس - 30,000 دينار</option>
                <option value="standard">ستاندرد - 50,000 دينار</option>
                <option value="plus">بلص - 35,000 دينار</option>
                <option value="other">أخرى</option>
            </select>
            <div id="customAmountContainer">
                <label>المبلغ المخصص:</label>
                <input type="number" id="customAmount">
            </div>
        </div>
        <div class="form-group">
            <label>اسم المسوق:</label>
            <input type="text" id="marketer">
        </div>
        <div class="form-group">
            <label>عمولة المسوق:</label>
            <input type="number" id="customCommission" value="0">
        </div>
        <div class="form-group">
            <label>تاريخ الاشتراك:</label>
            <input type="date" id="subscriptionDate">
        </div>
        <button onclick="saveCustomer()">حفظ</button>
        <button onclick="cancelEdit()" style="display: none; background-color: #9e9e9e;" id="cancelBtn">إلغاء</button>
    </div>

    <!-- قسم تسديد الدفعات -->
    <div class="form-container">
        <h2>تسديد دفعة</h2>
        <div class="form-group">
            <label>اختر المشترك:</label>
            <select id="paymentCustomer"></select>
        </div>
        <div class="form-group">
            <label>المبلغ المدفوع:</label>
            <input type="number" id="paymentAmount">
        </div>
        <div class="form-group">
            <label>تاريخ الدفعة:</label>
            <input type="date" id="paymentDate">
        </div>
        <button onclick="addPayment()">تسجيل الدفع</button>
    </div>
</div>

<h2 style="color: #4285f4; text-align: center;">كشف الحسابات</h2>
<div style="overflow-x: auto;">
    <table id="customersTable">
        <thead>
            <tr>
                <th>اسم المشترك</th>
                <th>نوع الاشتراك</th>
                <th>المبلغ</th>
                <th>تاريخ الاشتراك</th>
                <th>الحالة</th>
                <th>المسوق</th>
                <th>عمولة</th>
                <th>إجراءات</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="form-container" style="margin-top: 20px;">
    <h3>إجماليات:</h3>
    <div class="summary-grid">
        <div class="summary-card">
            <h4>المشتركين</h4>
            <p>إجمالي المشتركين: <strong><span id="totalCustomers">0</span></strong></p>
            <p>المسددون: <strong><span id="paidCustomers">0</span></strong></p>
            <p>غير المسددين: <strong><span id="unpaidCustomers">0</span></strong></p>
        </div>
        <div class="summary-card">
            <h4>المدفوعات</h4>
            <p>إجمالي الأجل: <strong><span id="totalDue">0</span> دينار</strong></p>
            <p>إجمالي المسدد: <strong><span id="totalPaid">0</span> دينار</strong></p>
            <p>المتبقي: <strong><span id="totalRemaining">0</span> دينار</strong></p>
            <p>نسبة السداد: <strong><span id="paymentPercentage">0%</span></strong></p>
        </div>
        <div class="summary-card">
            <h4>عمولات المسوقين</h4>
            <p>إجمالي العمولات: <strong><span id="totalCommissions">0</span> دينار</strong></p>
            <p>متوسط العمولة: <strong><span id="avgCommission">0</span> دينار</strong></p>
            <p>نسبة العمولة: <strong><span id="commissionPercentage">0%</span></strong></p>
        </div>
    </div>
</div>

<script>
// تعريف أنواع الاشتراك
const subscriptionPlans = {
    nb1: { name: "NB1", price: 25000, commission: 5000 },
    max: { name: "ماكس", price: 30000, commission: 6000 },
    standard: { name: "ستاندرد", price: 50000, commission: 10000 },
    plus: { name: "بلص", price: 35000, commission: 7000 },
    other: { name: "أخرى", price: 0, commission: 0 }
};

// البيانات الأساسية
let customers = JSON.parse(localStorage.getItem('internetCustomers')) || [];
let currentEditId = null;

// عند تحميل الصفحة
window.onload = function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("subscriptionDate").value = today;
    document.getElementById("paymentDate").value = today;
    
    updateCustomersDropdown();
    updateCustomersTable();
};

// عرض/إخفاء حقل المبلغ المخصص
function checkSubscriptionType() {
    const subscriptionType = document.getElementById("subscriptionType").value;
    document.getElementById("customAmountContainer").style.display = 
        (subscriptionType === "other") ? "block" : "none";
}

// حفظ/تعديل مشترك
function saveCustomer() {
    const subscriptionType = document.getElementById("subscriptionType").value;
    let plan;
    
    if (subscriptionType === "other") {
        plan = {
            name: "أخرى",
            price: parseInt(document.getElementById("customAmount").value) || 0,
            commission: parseInt(document.getElementById("customCommission").value) || 0
        };
    } else {
        plan = subscriptionPlans[subscriptionType];
    }
    
    const customerData = {
        id: currentEditId || Date.now(),
        name: document.getElementById("customerName").value,
        subscription: subscriptionType,
        customPlan: subscriptionType === "other" ? plan : null,
        marketer: document.getElementById("marketer").value,
        subscriptionDate: document.getElementById("subscriptionDate").value,
        payments: [],
        paid: false
    };
    
    if (currentEditId) {
        // تحديث المشترك الموجود
        const index = customers.findIndex(c => c.id === currentEditId);
        if (index !== -1) {
            customerData.payments = customers[index].payments;
            customerData.paid = customers[index].paid;
            customers[index] = customerData;
        }
    } else {
        // إضافة مشترك جديد
        customers.push(customerData);
    }
    
    saveData();
    cancelEdit();
    updateCustomersDropdown();
    updateCustomersTable();
}

// تسديد دفعة
function addPayment() {
    const customerId = parseInt(document.getElementById("paymentCustomer").value);
    const amount = parseInt(document.getElementById("paymentAmount").value);
    const paymentDate = document.getElementById("paymentDate").value;
    
    const customer = customers.find(c => c.id === customerId);
    if (customer) {
        customer.payments.push({
            amount: amount,
            date: paymentDate
        });
        
        const plan = customer.customPlan || subscriptionPlans[customer.subscription];
        const totalPaid = customer.payments.reduce((sum, p) => sum + p.amount, 0);
        customer.paid = totalPaid >= plan.price;
        
        saveData();
        updateCustomersTable();
        document.getElementById("paymentAmount").value = "";
    }
}

// تعديل مشترك
function editCustomer(id) {
    const customer = customers.find(c => c.id === id);
    if (!customer) return;
    
    currentEditId = id;
    document.getElementById("editId").value = id;
    document.getElementById("customerName").value = customer.name;
    document.getElementById("marketer").value = customer.marketer;
    document.getElementById("subscriptionDate").value = customer.subscriptionDate;
    
    if (customer.customPlan) {
        document.getElementById("subscriptionType").value = "other";
        document.getElementById("customAmount").value = customer.customPlan.price;
        document.getElementById("customCommission").value = customer.customPlan.commission;
        document.getElementById("customAmountContainer").style.display = "block";
    } else {
        document.getElementById("subscriptionType").value = customer.subscription;
        document.getElementById("customAmountContainer").style.display = "none";
    }
    
    document.getElementById("cancelBtn").style.display = "block";
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// حذف مشترك
function deleteCustomer(id) {
    if (confirm("هل أنت متأكد من حذف هذا المشترك؟")) {
        customers = customers.filter(c => c.id !== id);
        saveData();
        updateCustomersDropdown();
        updateCustomersTable();
    }
}

// إلغاء التعديل
function cancelEdit() {
    currentEditId = null;
    document.getElementById("editId").value = "";
    document.getElementById("customerName").value = "";
    document.getElementById("marketer").value = "";
    document.getElementById("customAmount").value = "";
    document.getElementById("customCommission").value = "0";
    document.getElementById("subscriptionType").selectedIndex = 0;
    document.getElementById("subscriptionDate").value = new Date().toISOString().split('T')[0];
    document.getElementById("customAmountContainer").style.display = "none";
    document.getElementById("cancelBtn").style.display = "none";
}

// تحديث القائمة المنسدلة للمشتركين
function updateCustomersDropdown() {
    const dropdown = document.getElementById("paymentCustomer");
    dropdown.innerHTML = customers.map(c => {
        const plan = c.customPlan || subscriptionPlans[c.subscription];
        return `<option value="${c.id}">${c.name} - ${plan.name} (${plan.price} دينار)</option>`;
    }).join("");
}

// تحديث جدول المشتركين
function updateCustomersTable() {
    const tableBody = document.querySelector("#customersTable tbody");
    tableBody.innerHTML = customers.map(customer => {
        const plan = customer.customPlan || subscriptionPlans[customer.subscription];
        const totalPaid = customer.payments.reduce((sum, p) => sum + p.amount, 0);
        const remaining = plan.price - totalPaid;
        const status = customer.paid ? 
            `<span style="color: green;">مسدد</span>` : 
            `دفع: ${totalPaid} - بقي: <span style="color: red;">${remaining}</span>`;
        
        return `
        <tr class="${customer.paid ? 'paid' : 'unpaid'}">
            <td>${customer.name}</td>
            <td><span class="subscription-badge ${customer.subscription === 'other' ? 'other' : customer.subscription}">
                ${plan.name}${customer.customPlan ? '*' : ''}
            </span></td>
            <td>${plan.price.toLocaleString()}</td>
            <td>${customer.subscriptionDate}</td>
            <td>${status}</td>
            <td>${customer.marketer}</td>
            <td>${customer.paid ? plan.commission.toLocaleString() : '0'}</td>
            <td>
                <div class="action-buttons">
                    <button class="edit" onclick="editCustomer(${customer.id})">تعديل</button>
                    <button class="delete" onclick="deleteCustomer(${customer.id})">حذف</button>
                </div>
            </td>
        </tr>`;
    }).join("");
    
    // حساب الإجماليات
    const totalCustomers = customers.length;
    const paidCustomers = customers.filter(c => c.paid).length;
    const unpaidCustomers = totalCustomers - paidCustomers;
    
    const totalDue = customers.reduce((sum, c) => {
        const plan = c.customPlan || subscriptionPlans[c.subscription];
        return sum + plan.price;
    }, 0);
    
    const totalPaid = customers.reduce((sum, c) => 
        sum + c.payments.reduce((s, p) => s + p.amount, 0), 0);
    
    const totalCommissions = customers.filter(c => c.paid)
        .reduce((sum, c) => {
            const plan = c.customPlan || subscriptionPlans[c.subscription];
            return sum + plan.commission;
        }, 0);
    
    const paymentPercentage = totalDue > 0 ? Math.round((totalPaid / totalDue) * 100) : 0;
    const commissionPercentage = totalPaid > 0 ? Math.round((totalCommissions / totalPaid) * 100) : 0;
    const avgCommission = paidCustomers > 0 ? Math.round(totalCommissions / paidCustomers) : 0;
    
    document.getElementById("totalCustomers").textContent = totalCustomers;
    document.getElementById("paidCustomers").textContent = paidCustomers;
    document.getElementById("unpaidCustomers").textContent = unpaidCustomers;
    document.getElementById("totalDue").textContent = totalDue.toLocaleString();
    document.getElementById("totalPaid").textContent = totalPaid.toLocaleString();
    document.getElementById("totalRemaining").textContent = (totalDue - totalPaid).toLocaleString();
    document.getElementById("totalCommissions").textContent = totalCommissions.toLocaleString();
    document.getElementById("paymentPercentage").textContent = paymentPercentage + "%";
    document.getElementById("commissionPercentage").textContent = commissionPercentage + "%";
    document.getElementById("avgCommission").textContent = avgCommission.toLocaleString();
}

// حفظ البيانات
function saveData() {
    localStorage.setItem('internetCustomers', JSON.stringify(customers));
}
</script>

</body>
</html>
